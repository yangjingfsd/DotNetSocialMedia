@{
    ViewData["Title"] = "Create Post";
}

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js';
        import { getDatabase, ref as dbRef, set, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js";

        const firebaseConfig = {
    apiKey: "AIzaSyB8WcalDpquZO5Xhq2fgCP7rA3IC-Qdfvg",
    authDomain: "dotnetsocialmedia-df2ee.firebaseapp.com",
    databaseURL: "https://dotnetsocialmedia-df2ee-default-rtdb.firebaseio.com",
    projectId: "dotnetsocialmedia-df2ee",
    storageBucket: "dotnetsocialmedia-df2ee.appspot.com",
    messagingSenderId: "630837754281",
    appId: "1:630837754281:web:99bc8cc7376d26b3b6acb8",
    measurementId: "G-VCEN603ERC"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        const postsRef = dbRef(database, 'Posts');
        const imgsRef = storageRef(storage, "images");
        
        async function addPost(userId, title, content, imgURL) {
            try {
                const newPostRef = push(postsRef);
                await set(newPostRef, { userId, title, content, imgURL });
                console.log('Post created!');
                window.location.href="/Main/homepage";
            } catch (error) {
                console.error('Error message: ', error);
            }
        }
  
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addPostForm').addEventListener('submit', (event) => {
                event.preventDefault();

                const userId ="John";
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
//                const createTime = new Date();
                const imgFile = document.getElementById('imgFile');
                const file = imgFile.files[0];  

                if(file){

                    const imgRef = storageRef(storage, `images/${file.name}`);

                try{
                
                    uploadBytes(imgRef, file).then((snapshot) => {

                    getDownloadURL(snapshot.ref).then((downloadURL) => {
                    addPost(userId, title, content, downloadURL);

                });
                });
                
                } catch(error) {
                
                alert('Upload failed:', error);
                
                }

                }   else {

                alert("No file is selected!");

                }
               
            });
        });

    </script>

<h2>Create a Post</h2>

<form id="addPostForm">

  <div data-mdb-input-init class="form-outline mb-4">
    <input type="text" id="title" class="form-control" />
    <label class="form-label" for="title">Post Title</label>
  </div>

  <!-- Message input -->
  <div data-mdb-input-init class="form-outline mb-4">
    <input type="text" id="content" class="form-control" />
    <label class="form-label" for="content">Post Content</label>
  </div>

  <div data-mdb-input-init>
    <label class="form-label" for="imgFile">Upload picture</label>
    <input type="file" class="form-control" id="imgFile" />
  </div>

<br/>

  <!-- Submit button -->
  <button data-mdb-ripple-init type="submit" class="btn btn-primary ">Create</button>

</form>
